{% extends "opensees/base.html" %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">OpenSees Analysis</h1>
    
    <!-- Analysis Input Form -->
    <div class="row">
        <div class="col-md-12">
            <form method="post" class="mb-4">
                {% csrf_token %}
                <div class="form-group mb-3">
                    <label for="input_data" class="form-label">OpenSees Model Script:</label>
                    <textarea id="input_data" name="input_data" class="form-control" rows="20" 
                              placeholder="Paste your OpenSees model definition script here..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">Run Analysis</button>
            </form>
        </div>
    </div>
    
    <!-- Analysis Results -->
    {% if result %}
        {% if result.success %}
            <div class="alert alert-success">
                <h4>Analysis Completed Successfully!</h4>
                
                <!-- Analysis Type Information -->
                {% if result.analysis_type %}
                    <p><strong>Analysis Type:</strong> {{ result.analysis_type|title|replace:"_":" " }}</p>
                {% endif %}
                
                <!-- Analysis Results Summary -->
                {% if result.analysis_results %}
                    <h5>Results Summary:</h5>
                    <ul>
                        {% for analysis_type, results in result.analysis_results.items %}
                            {% if results.error %}
                                <li><strong>{{ analysis_type|title }}:</strong> <span class="text-danger">Error - {{ results.error }}</span></li>
                            {% else %}
                                <li><strong>{{ analysis_type|title }}:</strong> <span class="text-success">Completed successfully</span></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}
                
                <!-- Output Files Information -->
                {% if result.output_files %}
                    <p><strong>Generated Files:</strong> {{ result.output_files|length }} files</p>
                {% endif %}
            </div>
            
            <!-- Convert to HTML Buttons -->
            <div class="mb-4">
                <h4>View Results:</h4>
                <div class="d-flex gap-3 flex-wrap">
                    <!-- Gravity Analysis Results -->
                    {% if result.analysis_type == "gravity_analysis" %}
                        <a href="{% url 'opensees:convert_to_html' project.pk task.pk %}" 
                           class="btn btn-success btn-lg">
                            <i class="fas fa-table"></i> View Gravity Analysis Results
                        </a>
                    {% endif %}
                    
                    <!-- Response Spectrum Analysis Results -->
                    {% if result.analysis_type == "response_spectrum_analysis" %}
                        <a href="{% url 'opensees:convert_to_html_rsa' project.pk task.pk %}" 
                           class="btn btn-success btn-lg">
                            <i class="fas fa-chart-line"></i> View RSA Results
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Generated Images -->
            {% if result.images %}
                <div class="mb-4">
                    <h4>Generated Plots:</h4>
                    <div class="row">
                        {% for name, url in result.images.items %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card-body">
                        <p>Sample script for response spectrum analysis with modal properties.</p>
                        <button class="btn btn-outline-info btn-sm" onclick="loadRSASample()">
                            Load Sample
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Custom Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadGravitySample() {
        const sampleScript = `# Gravity Analysis Sample Script
# Define your materials, sections, nodes, elements, loads, and analysis parameters

# Analysis type
analysis_type = "gravity_analysis"

# Materials (example)
materials = [
    [1, "Steel", "elastic", 29000000, 0.3],
    [2, "Concrete", "elastic", 4030000, 0.2]
]

# Section properties (example)
section_properties = [
    [1, "W18x50", "W", 14.7, 800, 40.1, 7.50, 0.570, 1.65]
]

# Nodes (example)
nodes = [
    [1, 0.0, 0.0, 0.0],
    [2, 120.0, 0.0, 0.0],
    [3, 240.0, 0.0, 0.0],
    [4, 0.0, 0.0, 144.0],
    [5, 120.0, 0.0, 144.0],
    [6, 240.0, 0.0, 144.0]
]

# Frame elements (example)
frame_elements = [
    [1, 1, 2, 1, 1, 1],
    [2, 2, 3, 1, 1, 1],
    [3, 1, 4, 1, 1, 1],
    [4, 2, 5, 1, 1, 1],
    [5, 3, 6, 1, 1, 1],
    [6, 4, 5, 1, 1, 1],
    [7, 5, 6, 1, 1, 1]
]

# Load cases
load_cases = [
    [1, "DL", "node_loads", 5, 0, 0, -5000, 0, 0, 0],
    [2, "DL", "node_loads", 6, 0, 0, -5000, 0, 0, 0],
    [3, "DL", "element_uniform_loads", 1, 0, -2500, 0],
    [4, "DL", "element_uniform_loads", 2, 0, -2500, 0],
    [8, "LL", "node_loads", 5, 0, 0, -5000, 0, 0, 0],
    [9, "LL", "node_loads", 6, 0, 0, -5000, 0, 0, 0]
]

# Load combinations
load_combinations = [
    [1, "combo1", "DL", 1.4],
    [2, "combo2", "DL", 1.2],
    [3, "combo2", "LL", 1.6],
    [4, "combo3", "DL", 1.2],
    [5, "combo3", "LL", 1.0]
]

# Analysis parameters
num_points = 5`;
        
        document.getElementById('input_data').value = sampleScript;
    }
    
    function loadRSASample() {
        const sampleScript = `# Response Spectrum Analysis Sample Script
# Define your materials, sections, nodes, elements, and RSA parameters

# Analysis type
analysis_type = "response_spectrum_analysis"

# Materials (example)
materials = [
    [1, "Steel", "elastic", 29000000, 0.3],
    [2, "Concrete", "elastic", 4030000, 0.2]
]

# Section properties (example)
section_properties = [
    [1, "W18x50", "W", 14.7, 800, 40.1, 7.50, 0.570, 1.65]
]

# Nodes (example)
nodes = [
    [1, 0.0, 0.0, 0.0],
    [2, 120.0, 0.0, 0.0],
    [3, 240.0, 0.0, 0.0],
    [4, 0.0, 0.0, 144.0],
    [5, 120.0, 0.0, 144.0],
    [6, 240.0, 0.0, 144.0]
]

# Frame elements (example)
frame_elements = [
    [1, 1, 2, 1, 1, 1],
    [2, 2, 3, 1, 1, 1],
    [3, 1, 4, 1, 1, 1],
    [4, 2, 5, 1, 1, 1],
    [5, 3, 6, 1, 1, 1],
    [6, 4, 5, 1, 1, 1],
    [7, 5, 6, 1, 1, 1]
]

# Response Spectrum Data
Tn = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.75, 1.0, 1.5, 2.0, 3.0, 4.0, 5.0]  # Periods (seconds)
Sa = [0.4, 0.8, 1.2, 1.0, 0.8, 0.7, 0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.12]  # Spectral accelerations (g)

# RSA parameters
num_modes = 7          # Number of modes to analyze
direction = 1          # Excitation direction (1=X, 2=Y, 3=Z)
num_points = 10        # Number of integration points

# Note: Add your fixities, transformations, elastic_section, 
# aggregator_section, beam_integrations, and other required parameters`;
        
        document.getElementById('input_data').value = sampleScript;
    }
</script>
{% endblock %}d">
                                    <img src="{{ url }}" class="card-img-top" alt="{{ name }}" 
                                         style="height: 200px; object-fit: contain;">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ name|title|replace:"_":" " }}</h6>
                                        <a href="{{ url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            View Full Size
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Raw Analysis Results (Collapsible) -->
            {% if result.analysis_results %}
                <div class="accordion" id="rawResultsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="rawResultsHeader">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#rawResultsContent" 
                                    aria-expanded="false" 
                                    aria-controls="rawResultsContent">
                                Raw Analysis Data (Advanced)
                            </button>
                        </h2>
                        <div id="rawResultsContent" 
                             class="accordion-collapse collapse" 
                             aria-labelledby="rawResultsHeader" 
                             data-bs-parent="#rawResultsAccordion">
                            <div class="accordion-body">
                                <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;">{{ result.analysis_results|pprint }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        
        {% else %}
            <!-- Error Display -->
            <div class="alert alert-danger">
                <h4>Analysis Failed</h4>
                {% if result.error %}
                    <p><strong>Error:</strong> {{ result.error }}</p>
                {% endif %}
                
                {% if result.traceback %}
                    <div class="accordion" id="errorAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="errorHeader">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#errorContent" 
                                        aria-expanded="false" 
                                        aria-controls="errorContent">
                                    View Error Details
                                </button>
                            </h2>
                            <div id="errorContent" 
                                 class="accordion-collapse collapse" 
                                 aria-labelledby="errorHeader" 
                                 data-bs-parent="#errorAccordion">
                                <div class="accordion-body">
                                    <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;">{{ result.traceback }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
    
    <!-- Sample Scripts Section -->
    <div class="mt-5">
        <h4>Sample Scripts:</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Gravity Analysis Sample</h5>
                    </div>
                    <div class="card-body">
                        <p>Sample script for gravity load analysis with load combinations.</p>
                        <button class="btn btn-outline-info btn-sm" onclick="loadGravitySample()">
                            Load Sample
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Response Spectrum Analysis Sample</h5>
                    </div>
                    <div class="car