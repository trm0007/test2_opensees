{% extends "opensees/base.html" %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">Response Spectrum Analysis Results - HTML Format</h1>
    
    <!-- Calculator Navigation -->
    {% include "opensees/calculator_nav.html" %}
    
    {% if error %}
        <div class="alert alert-danger">
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}
    
    {% if success %}
        <!-- Summary Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title text-success">âœ“ Response Spectrum Analysis Results Available</h5>
                        <p class="card-text">
                            Analysis completed successfully. Results are organized into different categories below.
                            You can download individual Excel files or view tables directly in the browser.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Download Buttons for All Results -->
        <div class="mb-4">
            <h4><i class="fas fa-download"></i> Download All Excel Files:</h4>
            <div class="row">
                {% for name, filename in all_excel_files.items %}
                    <div class="col-md-4 col-lg-3 mb-2">
                        <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk filename %}" 
                           class="btn btn-primary btn-sm w-100" download title="Download {{ name|title }} as Excel">
                            <i class="fas fa-file-excel"></i> {{ name|title|truncatechars:20 }}
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Results Accordion -->
        <div class="accordion" id="rsaResultsAccordion">
            
            <!-- Modal Properties Section -->
            {% if rsa_results.html_tables.modal_properties %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="modalPropertiesHeading">
                    <button class="accordion-button" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#modalPropertiesCollapse" 
                            aria-expanded="true" 
                            aria-controls="modalPropertiesCollapse">
                        <i class="fas fa-wave-square me-2"></i>
                        <strong>Modal Properties</strong>
                        <span class="badge bg-primary ms-2">Periods, Frequencies, Eigenvalues</span>
                    </button>
                </h2>
                <div id="modalPropertiesCollapse" 
                     class="accordion-collapse collapse show" 
                     aria-labelledby="modalPropertiesHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Modal Properties Table</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.modal_properties %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.modal_properties|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Participation Factors Section -->
            {% if rsa_results.html_tables.participation_factors %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="participationFactorsHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#participationFactorsCollapse" 
                            aria-expanded="false" 
                            aria-controls="participationFactorsCollapse">
                        <i class="fas fa-chart-line me-2"></i>
                        <strong>Modal Participation Factors & Effective Masses</strong>
                        <span class="badge bg-info ms-2">MX, MY, RMZ Directions</span>
                    </button>
                </h2>
                <div id="participationFactorsCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="participationFactorsHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Participation Factors and Effective Masses</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.participation_factors %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.participation_factors|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Floor Properties Section -->
            {% if rsa_results.html_tables.floor_properties %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="floorPropertiesHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#floorPropertiesCollapse" 
                            aria-expanded="false" 
                            aria-controls="floorPropertiesCollapse">
                        <i class="fas fa-building me-2"></i>
                        <strong>Floor Properties</strong>
                        <span class="badge bg-secondary ms-2">Floor Data</span>
                    </button>
                </h2>
                <div id="floorPropertiesCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="floorPropertiesHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Floor Properties Table</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.floor_properties %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.floor_properties|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- CQC Displacements Section -->
            {% if rsa_results.html_tables.cqc_displacements %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="cqcDisplacementsHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#cqcDisplacementsCollapse" 
                            aria-expanded="false" 
                            aria-controls="cqcDisplacementsCollapse">
                        <i class="fas fa-arrows-alt me-2"></i>
                        <strong>CQC Nodal Displacements</strong>
                        <span class="badge bg-success ms-2">Ux, Uy, Uz, Rx, Ry, Rz</span>
                    </button>
                </h2>
                <div id="cqcDisplacementsCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="cqcDisplacementsHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">CQC Combined Nodal Displacements</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.cqc_displacements %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.cqc_displacements|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- CQC Reactions Section -->
            {% if rsa_results.html_tables.cqc_reactions %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="cqcReactionsHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#cqcReactionsCollapse" 
                            aria-expanded="false" 
                            aria-controls="cqcReactionsCollapse">
                        <i class="fas fa-anchor me-2"></i>
                        <strong>CQC Nodal Reactions</strong>
                        <span class="badge bg-warning ms-2">Fx, Fy, Fz, Mx, My, Mz</span>
                    </button>
                </h2>
                <div id="cqcReactionsCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="cqcReactionsHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">CQC Combined Nodal Reactions</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.cqc_reactions %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.cqc_reactions|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Story Drifts Section -->
            {% if rsa_results.html_tables.story_drifts %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="storyDriftsHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#storyDriftsCollapse" 
                            aria-expanded="false" 
                            aria-controls="storyDriftsCollapse">
                        <i class="fas fa-expand-arrows-alt me-2"></i>
                        <strong>Story Drifts</strong>
                        <span class="badge bg-danger ms-2">Drift X, Drift Y</span>
                    </button>
                </h2>
                <div id="storyDriftsCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="storyDriftsHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Inter-story Drift Analysis</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.story_drifts %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.story_drifts|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Shear Results Section -->
            {% if rsa_results.html_tables.shear_results %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="shearResultsHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#shearResultsCollapse" 
                            aria-expanded="false" 
                            aria-controls="shearResultsCollapse">
                        <i class="fas fa-cut me-2"></i>
                        <strong>Base & Story Shears</strong>
                        <span class="badge bg-dark ms-2">Shear X, Shear Y</span>
                    </button>
                </h2>
                <div id="shearResultsCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="shearResultsHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Base and Story Shear Forces</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.shear_results %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.shear_results|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- CQC Member Forces Section -->
            {% if rsa_results.html_tables.cqc_member_forces %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="cqcMemberForcesHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#cqcMemberForcesCollapse" 
                            aria-expanded="false" 
                            aria-controls="cqcMemberForcesCollapse">
                        <i class="fas fa-compress-arrows-alt me-2"></i>
                        <strong>CQC Member Forces</strong>
                        <span class="badge bg-info ms-2">N, Vy, Vz, T, My, Mz</span>
                    </button>
                </h2>
                <div id="cqcMemberForcesCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="cqcMemberForcesHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">CQC Combined Member Forces</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.cqc_member_forces %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="alert alert-info">
                            <strong>Note:</strong> Forces shown for each element at multiple sections along the member length.
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.cqc_member_forces|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Critical Member Forces Section -->
            {% if rsa_results.html_tables.critical_member_forces %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="criticalMemberForcesHeading">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#criticalMemberForcesCollapse" 
                            aria-expanded="false" 
                            aria-controls="criticalMemberForcesCollapse">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Critical Member Forces</strong>
                        <span class="badge bg-danger ms-2">Max/Min Values</span>
                    </button>
                </h2>
                <div id="criticalMemberForcesCollapse" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="criticalMemberForcesHeading" 
                     data-bs-parent="#rsaResultsAccordion">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Maximum and Minimum Member Forces</h6>
                            <a href="{% url 'opensees:download_excel_rsa' project.pk task.pk rsa_results.excel_files.critical_member_forces %}" 
                               class="btn btn-outline-primary btn-sm" download>
                                <i class="fas fa-file-excel"></i> Download Excel
                            </a>
                        </div>
                        <div class="alert alert-warning">
                            <strong>Design Note:</strong> These are the critical (maximum/minimum) forces for each element, useful for design purposes.
                        </div>
                        <div class="table-responsive">
                            {{ rsa_results.html_tables.critical_member_forces|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Quick Statistics Card -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Analysis Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ all_excel_files|length }}</h4>
                                    <small class="text-muted">Excel Files Generated</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ rsa_results.html_tables|length }}</h4>
                                    <small class="text-muted">Data Tables Available</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">CQC</h4>
                                    <small class="text-muted">Combination Method</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">RSA</h4>
                                    <small class="text-muted">Analysis Type</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% endif %}
    
    <!-- Navigation -->
    <div class="mt-4 mb-5">
        <div class="row">
            <div class="col-md-6">
                <a href="{% url 'opensees:run_analysis' project.pk task.pk %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Analysis Input
                </a>
            </div>
            <div class="col-md-6 text-end">
                {% if success %}
                <button class="btn btn-outline-info" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Results
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS for accordion functionality -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom styles for better table display -->
<style>
.table {
    font-size: 0.9em;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: center;
}
.table td {
    text-align: center;
}
.accordion-button:not(.collapsed) {
    background-color: #e3f2fd;
    color: #1976d2;
}
.badge {
    font-size: 0.7em;
}
@media print {
    .btn, .accordion-button {
        display: none !important;
    }
    .accordion-collapse {
        display: block !important;
    }
}
</style>

{% endblock %}