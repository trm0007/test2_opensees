{% extends "opensees/base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Calculator 4: Seismic Analysis</h2>
    
    <!-- Navigation -->
    <div class="mb-4">
        <a href="{% url 'opensees:calculator1' project.pk task.pk %}" class="btn btn-outline-secondary">Model Generator</a>
        <a href="{% url 'opensees:calculator2' project.pk task.pk %}" class="btn btn-outline-secondary">Section Properties</a>
        <a href="{% url 'opensees:calculator3' project.pk task.pk %}" class="btn btn-outline-secondary">Concrete Properties</a>
        <a href="{% url 'opensees:calculator4' project.pk task.pk %}" class="btn btn-outline-primary">Seismic Analysis</a>
        <a href="{% url 'opensees:input' project.pk task.pk %}" class="btn btn-outline-secondary">← Back to Input</a>
    </div>
    
    <form method="post" class="mb-4">
        {% csrf_token %}
        
        <!-- Seismic Analysis Parameters Section -->
        <div class="form-row">
            <div class="col-md-12">
                <div id="seismic_params" class="mt-4">
                    <h4>Seismic Analysis Parameters</h4>
                    <div class="form-group">
                        <label for="seismic_parameters">Seismic Analysis Parameters (Python format):</label>
                        <textarea class="form-control" id="seismic_parameters" name="seismic_parameters" rows="20" required>
# ========================
# SEISMIC ANALYSIS PARAMETERS
# ========================

# Building Parameters
num_stories = 10
floor_height = 3.0  # meters
floor_weight = 5000.0  # kN per floor
building_type = "Concrete moment-resisting frames"

# Location and Site Parameters
location = "Dhaka"
nature_of_occupancy = "Elementary school or secondary school facilities with a capacity greater than 250"

# Structural System Parameters
system_type = "C. MOMENT RESISTING FRAME SYSTEMS (no shear wall)"
subtypes = "5. Intermediate reinforced concrete moment frames"

# SPT Data (Standard Penetration Test)
spt_depths = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5]  # meters
spt_values = [5, 10, 5, 14, 14, 20, 22, 24, 26, 24, 20, 30, 35, 35, 34, 24, 24, 10, 20, 25]  # N-values

# Analysis Options
analysis_type = "seismic_analysis"
include_dynamic_effects = True
include_soil_structure_interaction = False

# Output Options
generate_plots = True
output_format = "detailed"
                        </textarea>
                    </div>
                    <small class="form-text text-muted">
                        Enter all seismic analysis parameters in Python format. Modify the values above according to your building requirements.
                        Available locations: Dhaka, Chittagong, Sylhet, Rangpur, Barisal, Khulna, Rajshahi, Mymensingh, etc.
                        Available building types: Concrete moment-resisting frames, Steel moment-resisting frames, etc.
                    </small>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg">Perform Seismic Analysis</button>
    </form>
    
    <!-- Results Section -->
    {% if result %}
        {% if result.error %}
        <div class="alert alert-danger">
            <h4>Error:</h4>
            <p>{{ result.error }}</p>
        </div>
        {% else %}
        
        <!-- Building Parameters Results -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Building Parameters</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Building Type:</strong> {{ result.building_parameters.building_type }}</p>
                        <p><strong>Number of Stories:</strong> {{ result.building_parameters.num_stories }}</p>
                        <p><strong>Total Height:</strong> {{ result.building_parameters.total_height|floatformat:2 }} m</p>
                        <p><strong>Total Weight:</strong> {{ result.building_parameters.total_weight|floatformat:0 }} kN</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Location:</strong> {{ result.building_parameters.location }}</p>
                        <p><strong>Occupancy Category:</strong> {{ result.building_parameters.occupancy_category }}</p>
                        <p><strong>Importance Factor (I):</strong> {{ result.building_parameters.importance_factor }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Soil Parameters Results -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4>Soil Parameters</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Corrected SPT Value:</strong> {{ result.soil_parameters.corrected_spt|floatformat:2 }}</p>
                        <p><strong>Soil Type:</strong> {{ result.soil_parameters.soil_type }}</p>
                        <p><strong>Soil Factor (S):</strong> {{ result.soil_parameters.soil_factor }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>TB:</strong> {{ result.soil_parameters.TB }}</p>
                        <p><strong>TC:</strong> {{ result.soil_parameters.TC }}</p>
                        <p><strong>TD:</strong> {{ result.soil_parameters.TD }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Structural Parameters Results -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4>Structural Parameters</h4>
            </div>
            <div class="card-body">
                <p><strong>System Type:</strong> {{ result.structural_parameters.system_type }}</p>
                <p><strong>Subtype:</strong> {{ result.structural_parameters.subtypes }}</p>
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Response Reduction Factor (R):</strong> {{ result.structural_parameters.R }}</p>
                        <p><strong>Overstrength Factor (Ω):</strong> {{ result.structural_parameters.omega }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Deflection Amplification Factor (Cd):</strong> {{ result.structural_parameters.Cd }}</p>
                        <p><strong>Building Period Coefficient (Ct):</strong> {{ result.structural_parameters.Ct }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Building Period Exponent (m):</strong> {{ result.structural_parameters.m }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Results -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4>Analysis Results</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Building Period (T):</strong> {{ result.analysis_results.building_period|floatformat:3 }} sec</p>
                        <p><strong>Seismic Zone Coefficient (Z):</strong> {{ result.analysis_results.seismic_zone_coefficient }}</p>
                        <p><strong>Normalized Acceleration Spectrum (Cs):</strong> {{ result.analysis_results.normalized_spectrum|floatformat:4 }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Design Acceleration (Sa):</strong> {{ result.analysis_results.design_acceleration|floatformat:4 }}</p>
                        <p><strong>Base Shear (V):</strong> {{ result.analysis_results.base_shear|floatformat:2 }} kN</p>
                        <p><strong>Distribution Factor (k):</strong> {{ result.analysis_results.k_factor|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Story Forces and Shears -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h4>Story Forces and Shears</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Story</th>
                                <th>Height (m)</th>
                                <th>Weight (kN)</th>
                                <th>Force (kN)</th>
                                <th>Shear (kN)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for story in result.story_results %}
                            <tr>
                                <td>{{ story.story }}</td>
                                <td>{{ story.height|floatformat:2 }}</td>
                                <td>{{ story.weight|floatformat:0 }}</td>
                                <td>{{ story.force|floatformat:2 }}</td>
                                <td>{{ story.shear|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Copy Code Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Analysis Code</h4>
                <button onclick="copyAnalysisCode()" class="btn btn-sm btn-outline-secondary float-right">Copy Code</button>
            </div>
            <div class="card-body">
                <pre id="analysis-code" class="bg-light p-3" style="font-size: 0.9em;">
# Seismic Analysis Results
# Building: {{ result.building_parameters.building_type }}
# Location: {{ result.building_parameters.location }}
# Stories: {{ result.building_parameters.num_stories }}

import numpy as np

# Building parameters
num_stories = {{ result.building_parameters.num_stories }}
total_height = {{ result.building_parameters.total_height }}
total_weight = {{ result.building_parameters.total_weight }}

# Analysis results
building_period = {{ result.analysis_results.building_period }}
base_shear = {{ result.analysis_results.base_shear }}
seismic_zone_coefficient = {{ result.analysis_results.seismic_zone_coefficient }}

# Story results
story_forces = [{% for story in result.story_results %}{{ story.force|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}]
story_shears = [{% for story in result.story_results %}{{ story.shear|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}]

print("Seismic Analysis Complete")
print(f"Base Shear: {base_shear:.2f} kN")
print(f"Building Period: {building_period:.3f} sec")
                </pre>
            </div>
        </div>
        
        {% endif %}
    {% endif %}
    
    <!-- Default Parameters Code Block -->
    <div class="card" style="position: relative; padding: 20px; border: 1px solid #ccc; border-radius: 10px; font-family: monospace;">
        <button onclick="copySeismicCode(this)" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px; cursor: pointer;">Copy</button>
        
        <div id="seismic-code-block">
            <pre>
# ========================
# SEISMIC ANALYSIS PARAMETERS
# ========================

# Building Parameters
num_stories = 10
floor_height = 3.0  # meters
floor_weight = 5000.0  # kN per floor
building_type = "Concrete moment-resisting frames"

# Location and Site Parameters
location = "Dhaka"
nature_of_occupancy = "Elementary school or secondary school facilities with a capacity greater than 250"

# Structural System Parameters
system_type = "C. MOMENT RESISTING FRAME SYSTEMS (no shear wall)"
subtypes = "5. Intermediate reinforced concrete moment frames"

# SPT Data (Standard Penetration Test)
spt_depths = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5]  # meters
spt_values = [5, 10, 5, 14, 14, 20, 22, 24, 26, 24, 20, 30, 35, 35, 34, 24, 24, 10, 20, 25]  # N-values

# Analysis Options
analysis_type = "seismic_analysis"
include_dynamic_effects = True
include_soil_structure_interaction = False

# Available Options:
# Building Types: "Concrete moment-resisting frames", "Steel moment-resisting frames", 
#                "Eccentrically braced steel frame", "All other structural systems"
#
# Locations: "Dhaka", "Chittagong", "Sylhet", "Rangpur", "Barisal", "Khulna", 
#           "Rajshahi", "Mymensingh", "Comilla", "Bogra", etc.
#
# System Types: "A. BEARING WALL SYSTEMS", 
#              "B. BUILDING FRAME SYSTEMS (with bracing or shear wall)",
#              "C. MOMENT RESISTING FRAME SYSTEMS (no shear wall)", etc.

# Output Options
generate_plots = True
output_format = "detailed"
            </pre>
        </div>
    </div>
    
    <div class="mt-4">
        <p>Logged in as: <strong>{{ user.username }}</strong></p>
        <p>Project: <strong>{{ project.name }}</strong></p>
        <p>Task: <strong>{{ task.name }}</strong></p>
    </div>
</div>

<script>
function copySeismicCode(button) {
    const code = button.parentElement.querySelector('#seismic-code-block').innerText;
    navigator.clipboard.writeText(code).then(() => {
        button.textContent = "Copied!";
        setTimeout(() => button.textContent = "Copy", 2000);
    });
}

function copyAnalysisCode() {
    const code = document.getElementById('analysis-code').innerText;
    navigator.clipboard.writeText(code).then(() => {
        const button = document.querySelector('button[onclick="copyAnalysisCode()"]');
        const originalText = button.textContent;
        button.textContent = "Copied!";
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy code. Please select and copy manually.');
    });
}

// Form validation for textarea input
document.querySelector('form').addEventListener('submit', function(e) {
    const seismicParams = document.getElementById('seismic_parameters').value.trim();
    
    if (seismicParams.length < 100) {
        e.preventDefault();
        alert('Please enter valid seismic analysis parameters!');
        return;
    }
    
    // Basic validation for required parameters
    const requiredParams = ['num_stories', 'floor_height', 'floor_weight', 'location', 'spt_depths', 'spt_values'];
    const missingParams = requiredParams.filter(param => !seismicParams.includes(param));
    
    if (missingParams.length > 0) {
        e.preventDefault();
        alert(`Missing required parameters: ${missingParams.join(', ')}`);
        return;
    }
});
</script>

{% endblock %}