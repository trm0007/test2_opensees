{% extends "opensees/base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Calculator 6: Center of Mass Analysis</h2>
    
    <!-- Navigation -->
    {% include "opensees/calculator_nav.html" %}
    
    <form method="post" class="mb-4">
        {% csrf_token %}
        
        <!-- Mass Analysis Parameters Section -->
        <div class="form-row">
            <div class="col-md-12">
                <div id="mass_params" class="mt-4">
                    <h4>Center of Mass Parameters</h4>
                    <div class="form-group">
                        <label for="mass_parameters">Structural Model Parameters (Python format):</label>
                        <textarea class="form-control" id="mass_parameters" name="mass_parameters" rows="25" required>
# =============================================
# CENTER OF MASS ANALYSIS PARAMETERS
# =============================================

# Node definitions: [nodeTag, x-coord, y-coord, z-coord, mass]
# mass = [mx, my, mz, rx, ry, rz] or None for fixed nodes
nodes = [
    [1, 0, 0, 0, None],                    # Base nodes
    [2, 0, 0, 3, [200, 200, 200, 0, 0, 0]],
    [3, 4, 0, 3, [200, 200, 200, 0, 0, 0]],
    [4, 4, 0, 0, None],
    [5, 0, 0, 6, [200, 200, 200, 0, 0, 0]],
    [6, 4, 0, 6, [200, 200, 200, 0, 0, 0]],
    [7, 4, 3, 6, [200, 200, 200, 0, 0, 0]],
    [8, 0, 3, 6, [200, 200, 200, 0, 0, 0]],
    [9, 0, 3, 3, [200, 200, 200, 0, 0, 0]],
    [10, 0, 3, 0, None],
    [11, 4, 3, 3, [200, 200, 200, 0, 0, 0]],
    [12, 4, 3, 0, None],
    [13, 2, 1.5, 6, None],  # Diaphragm masters
    [14, 2, 1.5, 3, None],
]

# Frame elements: [type, tag, iNode, jNode, transformation, integration]
frame_elements = [
    ["forceBeamColumn", 1, 1, 2, 1, 1],
    ["forceBeamColumn", 2, 2, 3, 2, 1],
    ["forceBeamColumn", 3, 4, 3, 3, 1],
    ["forceBeamColumn", 4, 2, 5, 4, 1],
    ["forceBeamColumn", 5, 5, 6, 5, 1],
    ["forceBeamColumn", 6, 7, 6, 6, 1],
    ["forceBeamColumn", 7, 8, 7, 7, 1],
    ["forceBeamColumn", 8, 9, 2, 8, 1],
    ["forceBeamColumn", 9, 8, 5, 9, 1],
    ["forceBeamColumn", 10, 10, 9, 10, 1],
    ["forceBeamColumn", 11, 3, 6, 11, 1],
    ["forceBeamColumn", 12, 11, 7, 12, 1],
    ["forceBeamColumn", 13, 11, 3, 13, 1],
    ["forceBeamColumn", 14, 9, 11, 14, 1],
    ["forceBeamColumn", 15, 12, 11, 15, 1],
    ["forceBeamColumn", 16, 9, 8, 16, 1]
]

# Load cases
load_cases = [
    # Dead Load (DL) - Node Loads
    [1, "DL", "node_loads", 5, 0, 0, -5000, 0, 0, 0],
    [2, "DL", "node_loads", 6, 0, 0, -5000, 0, 0, 0],
    
    # Dead Load (DL) - Element Uniform Loads
    [3, "DL", "element_uniform_loads", 1, 0, -2500, 0],
    [4, "DL", "element_uniform_loads", 2, 0, -2500, 0],
    
    # Dead Load (DL) - Element Point Loads
    [5, "DL", "element_point_loads", 1, 1000, -500, 0, 0.5],
    [6, "DL", "element_point_loads", 2, 0, 0, -2000, 0.7],
    
    # Live Load (LL) - Node Loads
    [8, "LL", "node_loads", 5, 0, 0, -5000, 0, 0, 0],
    [9, "LL", "node_loads", 6, 0, 0, -5000, 0, 0, 0],
    
    # Live Load (LL) - Element Uniform Loads
    [10, "LL", "element_uniform_loads", 1, 0, -2500, 0],
    [11, "LL", "element_uniform_loads", 2, 0, -2500, 0],
    
    # Wind Load (WL) - Node Loads
    [12, "WL", "node_loads", 5, 5000, 0, 0, 0, 0, 0],
    [13, "WL", "node_loads", 6, 5000, 0, 0, 0, 0, 0],
    
    # Seismic Load (EQ) - Node Loads
    [15, "EQ", "node_loads", 5, 10000, 0, 0, 0, 0, 0],
    [16, "EQ", "node_loads", 6, 10000, 0, 0, 0, 0, 0]
]

# Load combinations (must include "unfactored" combination)
load_combinations = [
    # Combo1: 1.4DL
    [1, "combo1", "DL", 1.4],
    
    # Combo2: 1.2DL + 1.6LL
    [2, "combo2", "DL", 1.2],
    [3, "combo2", "LL", 1.6],
    
    # Combo3: 1.2DL + 1.0LL + 1.0WL
    [4, "combo3", "DL", 1.2],
    [5, "combo3", "LL", 1.0],
    [6, "combo3", "WL", 1.0],
    
    # Combo4: 1.2DL + 1.0LL + 1.0EQ
    [7, "combo4", "DL", 1.2],
    [8, "combo4", "LL", 1.0],
    [9, "combo4", "EQ", 1.0],
    
    # Combo5: 0.9DL + 1.0WL
    [10, "combo5", "DL", 0.9],
    [11, "combo5", "WL", 1.0],
    
    # Combo6: 0.9DL + 1.0EQ
    [12, "combo6", "DL", 0.9],
    [13, "combo6", "EQ", 1.0],

    # unfactored: 1.0DL + 1.0LL + 1.0WL + 1.0EQ
    [14, "unfactored", "DL", 1.0],
    [15, "unfactored", "EQ", 1.0],
    [16, "unfactored", "LL", 1.0],
    [17, "unfactored", "WL", 1.0]
]

# =============================================
# NOTES:
# 1. Only nodes with mass data will be considered
# 2. Only frame elements are considered (shell elements are ignored)
# 3. Only the "unfactored" load combination is used
# 4. Mass units should be consistent (kg or kN/g)
# 5. Coordinates should be in consistent units (meters recommended)
# =============================================
                        </textarea>
                    </div>
                    <small class="form-text text-muted">
                        Enter your structural model parameters in Python format. Modify the values above according to your structure.
                        The analysis will calculate the center of mass for each floor considering nodal masses and unfactored loads.
                    </small>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg">Calculate Center of Mass</button>
    </form>
    
<!-- Add this section after the Center of Mass Results card -->

{{result.report_data}}
<!-- Load Report Section -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h4>Modified Load Cases Report</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>#</th>
                        <th>Case</th>
                        <th>Type</th>
                        <th>Target</th>
                        <th>Fx</th>
                        <th>Fy</th>
                        <th>Fz</th>
                        <th>Mx</th>
                        <th>My</th>
                        <th>Mz</th>
                    </tr>
                </thead>
                <tbody>
                    {% for load in result.report_data %}
                    <tr>
                        <td>{{ load.0 }}</td>
                        <td>{{ load.1 }}</td>
                        <td>{{ load.2 }}</td>
                        <td>{{ load.3 }}</td>
                        <td>{{ load.4|floatformat:2 }}</td>
                        <td>{{ load.5|floatformat:2 }}</td>
                        <td>{{ load.6|floatformat:2 }}</td>
                        <td>{{ load.7|floatformat:2 }}</td>
                        <td>{{ load.8|floatformat:2 }}</td>
                        <td>{{ load.9|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>





    <!-- Results Section -->
    {% if result %}
        {% if result.error %}
        <div class="alert alert-danger">
            <h4>Error:</h4>
            <p>{{ result.error }}</p>
        </div>
        {% else %}
        
        <!-- Model Summary -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Model Summary</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Number of Nodes:</strong> {{ result.nodes|length }}</p>
                        <p><strong>Number of Frame Elements:</strong> {{ result.frame_elements|length }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Number of Load Cases:</strong> {{ result.load_cases|length }}</p>
                        <p><strong>Number of Load Combinations:</strong> {{ result.load_combinations|length }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Center of Mass Results -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4>Center of Mass Results</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Floor</th>
                                <th>Elevation (m)</th>
                                <th>Total Mass (kg)</th>
                                <th>COM X (m)</th>
                                <th>COM Y (m)</th>
                                <th>COM Z (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for floor, data in result.floor_com.items %}
                            <tr>
                                <td>{{ floor }}</td>
                                <td>{{ data.floor_z }}</td>
                                <td>{{ data.total_mass|floatformat:2 }}</td>
                                <td>{{ data.com_x|floatformat:2 }}</td>
                                <td>{{ data.com_y|floatformat:2 }}</td>
                                <td>{{ data.com_z|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Visualization -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4>Visualization</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Plan View (X-Y)</h5>
                        <div id="plan-view" style="height: 300px; background-color: #f8f9fa; border: 1px solid #ddd;"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Elevation View (X-Z)</h5>
                        <div id="elevation-view" style="height: 300px; background-color: #f8f9fa; border: 1px solid #ddd;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Copy Code Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Analysis Code</h4>
                <button onclick="copyAnalysisCode()" class="btn btn-sm btn-outline-secondary float-right">Copy Code</button>
            </div>
            <div class="card-body">
                <pre id="analysis-code" class="bg-light p-3" style="font-size: 0.9em;">
# Center of Mass Analysis Results
# Number of Floors: {{ result.floor_com|length }}

# Floor-wise Center of Mass
{% for floor, data in result.floor_com.items %}
# Floor {{ floor }} (z = {{ data.floor_z }} m):
#   Total Mass: {{ data.total_mass|floatformat:2 }} kg
#   COM: ({{ data.com_x|floatformat:2 }}, {{ data.com_y|floatformat:2 }}, {{ data.com_z|floatformat:2 }})
{% endfor %}

# Analysis Parameters
# Gravity: 9.81 m/sÂ²
# Load Combination: unfactored (1.0DL + 1.0LL + 1.0WL + 1.0EQ)
# Only considered frame elements (shell elements ignored)
                </pre>
            </div>
        </div>
        
        {% endif %}
    {% endif %}
    
    <!-- Default Parameters Code Block -->
    <div class="card" style="position: relative; padding: 20px; border: 1px solid #ccc; border-radius: 10px; font-family: monospace;">
        <button onclick="copyMassCode(this)" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px; cursor: pointer;">Copy</button>
        
        <div id="mass-code-block">
            <pre>
# =============================================
# CENTER OF MASS ANALYSIS PARAMETERS
# =============================================

# Node definitions format:
# [nodeTag, x-coord, y-coord, z-coord, mass]
# mass = [mx, my, mz, rx, ry, rz] or None for fixed nodes
# Example:
nodes = [
    [1, 0, 0, 0, None],                    # Base node
    [2, 0, 0, 3, [200, 200, 200, 0, 0, 0]], # Node with mass
    [3, 4, 0, 3, [200, 200, 200, 0, 0, 0]],
]

# Frame elements format:
# [type, tag, iNode, jNode, transformation, integration]
# Example:
frame_elements = [
    ["forceBeamColumn", 1, 1, 2, 1, 1],
    ["forceBeamColumn", 2, 2, 3, 2, 1],
]

# Load cases format:
# [loadTag, case, type, *args]
# Example:
load_cases = [
    [1, "DL", "node_loads", 2, 0, 0, -5000, 0, 0, 0], # Node load
    [2, "DL", "element_uniform_loads", 1, 0, -2500, 0], # Element uniform load
]

# Load combinations format:
# [comboTag, comboName, case, factor]
# Must include "unfactored" combination
load_combinations = [
    [1, "combo1", "DL", 1.4],
    [2, "unfactored", "DL", 1.0],
    [3, "unfactored", "LL", 1.0],
]

# =============================================
# NOTES:
# 1. Only nodes with mass data will be considered
# 2. Only frame elements are considered (shell elements are ignored)
# 3. Only the "unfactored" load combination is used
# 4. Mass units should be consistent (kg or kN/g)
# 5. Coordinates should be in consistent units (meters recommended)
# =============================================
            </pre>
        </div>
    </div>
    
    <div class="mt-4">
        <p>Logged in as: <strong>{{ user.username }}</strong></p>
        <p>Project: <strong>{{ project.name }}</strong></p>
        <p>Task: <strong>{{ task.name }}</strong></p>
    </div>
</div>



{% endblock %}